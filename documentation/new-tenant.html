<!doctype html>
<html lang="en" class="govuk-template no-js">
  <head>
    <meta content="IE=edge" http-equiv="X-UA-Compatible">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">

    <title>M365 Configuration as Code - Technical Guidance</title>

    <link href="../stylesheets/manifest.css" rel="stylesheet" />

    <link rel="canonical" href="https://ministryofjustice.github.io/Staff-Infrastructure-Microsoft365-DSC-Documentation/documentation/new-tenant.html">

      <meta name="robots" content="noindex" />
      <meta name="twitter:card" content="summary" />
      <meta name="twitter:domain" content="ministryofjustice.github.io" />
      <meta name="twitter:image" content="https://ministryofjustice.github.io/Staff-Infrastructure-Microsoft365-DSC-Documentation/images/govuk-large.png" />
      <meta name="twitter:title" content="M365 Configuration as Code - Technical Guidance" />
      <meta name="twitter:url" content="https://ministryofjustice.github.io/Staff-Infrastructure-Microsoft365-DSC-Documentation/documentation/new-tenant.html" />

      <meta property="og:image" content="https://ministryofjustice.github.io/Staff-Infrastructure-Microsoft365-DSC-Documentation/images/govuk-large.png" />
      <meta property="og:site_name" content="M365 Configuration as Code - Technical Guidance" />
      <meta property="og:type" content="object" />
      <meta property="og:url" content="https://ministryofjustice.github.io/Staff-Infrastructure-Microsoft365-DSC-Documentation/documentation/new-tenant.html" />

    
  </head>

  <body class="govuk-template__body">
    <script>document.body.className = ((document.body.className) ? document.body.className + ' js-enabled' : 'js-enabled');</script>

    <div class="app-pane">
      <div class="app-pane__header toc-open-disabled">
        <a href="#content" class="govuk-skip-link" data-module="govuk-skip-link">Skip to main content</a>

        <header class="govuk-header app-header" role="banner" data-module="govuk-header">
  <div class="govuk-header__container govuk-header__container--full-width">
    <div class="govuk-header__logo">
      <a href="/" class="govuk-header__link govuk-header__link--homepage">
        <span class="govuk-header__logotype">
          <svg
            aria-hidden="true"
            focusable="false"
            class="govuk-header__logotype-crown"
            xmlns="http://www.w3.org/2000/svg"
            viewBox="0 0 132 97"
            height="30"
            width="36"
          >
            <path
              fill="currentColor" fill-rule="evenodd"
              d="M25 30.2c3.5 1.5 7.7-.2 9.1-3.7 1.5-3.6-.2-7.8-3.9-9.2-3.6-1.4-7.6.3-9.1 3.9-1.4 3.5.3 7.5 3.9 9zM9 39.5c3.6 1.5 7.8-.2 9.2-3.7 1.5-3.6-.2-7.8-3.9-9.1-3.6-1.5-7.6.2-9.1 3.8-1.4 3.5.3 7.5 3.8 9zM4.4 57.2c3.5 1.5 7.7-.2 9.1-3.8 1.5-3.6-.2-7.7-3.9-9.1-3.5-1.5-7.6.3-9.1 3.8-1.4 3.5.3 7.6 3.9 9.1zm38.3-21.4c3.5 1.5 7.7-.2 9.1-3.8 1.5-3.6-.2-7.7-3.9-9.1-3.6-1.5-7.6.3-9.1 3.8-1.3 3.6.4 7.7 3.9 9.1zm64.4-5.6c-3.6 1.5-7.8-.2-9.1-3.7-1.5-3.6.2-7.8 3.8-9.2 3.6-1.4 7.7.3 9.2 3.9 1.3 3.5-.4 7.5-3.9 9zm15.9 9.3c-3.6 1.5-7.7-.2-9.1-3.7-1.5-3.6.2-7.8 3.7-9.1 3.6-1.5 7.7.2 9.2 3.8 1.5 3.5-.3 7.5-3.8 9zm4.7 17.7c-3.6 1.5-7.8-.2-9.2-3.8-1.5-3.6.2-7.7 3.9-9.1 3.6-1.5 7.7.3 9.2 3.8 1.3 3.5-.4 7.6-3.9 9.1zM89.3 35.8c-3.6 1.5-7.8-.2-9.2-3.8-1.4-3.6.2-7.7 3.9-9.1 3.6-1.5 7.7.3 9.2 3.8 1.4 3.6-.3 7.7-3.9 9.1zM69.7 17.7l8.9 4.7V9.3l-8.9 2.8c-.2-.3-.5-.6-.9-.9L72.4 0H59.6l3.5 11.2c-.3.3-.6.5-.9.9l-8.8-2.8v13.1l8.8-4.7c.3.3.6.7.9.9l-5 15.4v.1c-.2.8-.4 1.6-.4 2.4 0 4.1 3.1 7.5 7 8.1h.2c.3 0 .7.1 1 .1.4 0 .7 0 1-.1h.2c4-.6 7.1-4.1 7.1-8.1 0-.8-.1-1.7-.4-2.4V34l-5.1-15.4c.4-.2.7-.6 1-.9zM66 92.8c16.9 0 32.8 1.1 47.1 3.2 4-16.9 8.9-26.7 14-33.5l-9.6-3.4c1 4.9 1.1 7.2 0 10.2-1.5-1.4-3-4.3-4.2-8.7L108.6 76c2.8-2 5-3.2 7.5-3.3-4.4 9.4-10 11.9-13.6 11.2-4.3-.8-6.3-4.6-5.6-7.9 1-4.7 5.7-5.9 8-.5 4.3-8.7-3-11.4-7.6-8.8 7.1-7.2 7.9-13.5 2.1-21.1-8 6.1-8.1 12.3-4.5 20.8-4.7-5.4-12.1-2.5-9.5 6.2 3.4-5.2 7.9-2 7.2 3.1-.6 4.3-6.4 7.8-13.5 7.2-10.3-.9-10.9-8-11.2-13.8 2.5-.5 7.1 1.8 11 7.3L80.2 60c-4.1 4.4-8 5.3-12.3 5.4 1.4-4.4 8-11.6 8-11.6H55.5s6.4 7.2 7.9 11.6c-4.2-.1-8-1-12.3-5.4l1.4 16.4c3.9-5.5 8.5-7.7 10.9-7.3-.3 5.8-.9 12.8-11.1 13.8-7.2.6-12.9-2.9-13.5-7.2-.7-5 3.8-8.3 7.1-3.1 2.7-8.7-4.6-11.6-9.4-6.2 3.7-8.5 3.6-14.7-4.6-20.8-5.8 7.6-5 13.9 2.2 21.1-4.7-2.6-11.9.1-7.7 8.8 2.3-5.5 7.1-4.2 8.1.5.7 3.3-1.3 7.1-5.7 7.9-3.5.7-9-1.8-13.5-11.2 2.5.1 4.7 1.3 7.5 3.3l-4.7-15.4c-1.2 4.4-2.7 7.2-4.3 8.7-1.1-3-.9-5.3 0-10.2l-9.5 3.4c5 6.9 9.9 16.7 14 33.5 14.8-2.1 30.8-3.2 47.7-3.2z"
            ></path>
          </svg>
          <span class="govuk-header__logotype-text">
            GOV.UK
          </span>
        </span>
        <span class="govuk-header__product-name">
          M365 Configuration as Code - Technical Guidance
        </span>
      </a>
    </div>
    <div class="govuk-header__content">
      <nav class="govuk-header__navigation govuk-header__navigation--end" aria-label="Menu">
        <button type="button" class="govuk-header__menu-button govuk-js-header-toggle" aria-controls="navigation" aria-label="Show or hide menu">Menu</button>
        <ul id="navigation" class="govuk-header__navigation-list">
            <li class="govuk-header__navigation-item">
              <a class="govuk-header__link" href="https://github.com/ministryofjustice/Staff-Infrastructure-Microsoft365-DSC-Documentation">GitHub</a>
            </li>
        </ul>
      </nav>
    </div>
  </div>
</header>

      </div>

        <div id="toc-heading" class="toc-show fixedsticky">
          <button type="button" class="toc-show__label js-toc-show" aria-controls="toc">
            Table of contents <span class="toc-show__icon"></span>
          </button>
        </div>

      <div class="app-pane__body" data-module="in-page-navigation">
          <div class="app-pane__toc">
            <div class="toc" data-module="table-of-contents" tabindex="-1" aria-label="Table of contents" role="dialog">
              
              <button type="button" class="toc__close js-toc-close" aria-controls="toc" aria-label="Hide table of contents"></button>
              <nav id="toc" class="js-toc-list toc__list" aria-labelledby="toc-heading" data-module="collapsible-navigation">
                      <ul>
  <li>
    <a href="#onboarding-a-new-tenant"><span>Onboarding a new tenant</span></a>
    <ul>
      <li>
        <ul>
          <li>
            <a href="#1-prerequisites"><span>1. Prerequisites</span></a>
          </li>
          <li>
            <a href="#2-create-app-registration"><span>2. Create App Registration</span></a>
          </li>
          <li>
            <a href="#3-provision-data-files"><span>3. Provision Data Files</span></a>
          </li>
          <li>
            <a href="#4-commit-changes"><span>4. Commit Changes</span></a>
          </li>
          <li>
            <a href="#5-run-the-dependencies-pipeline"><span>5. Run the Dependencies Pipeline</span></a>
          </li>
          <li>
            <a href="#6-validation"><span>6. Validation</span></a>
          </li>
        </ul>
      </li>
      <li>
        <a href="#compliancy-checks"><span>Compliancy Checks</span></a>
      </li>
    </ul>
  </li>
</ul>


              </nav>
            </div>
          </div>

        <div class="app-pane__content toc-open-disabled">
          <main id="content" class="technical-documentation" data-module="anchored-headings">
            <h1 id="onboarding-a-new-tenant">Onboarding a new tenant</h1>
<p>This section provides a detailed guide for onboarding a new tenant to the Microsoft365DSC automation solution. The onboarding process involves creating the necessary app registrations, configuring permissions, provisioning data files, and running the dependencies pipeline.</p>
<h3 id="1-prerequisites">1. Prerequisites</h3>
<p>Before onboarding a new tenant, ensure the following prerequisites are met:</p>

<ol>
<li>Access to the Staff-Infrastructure-Microsoft365-DSC-Configuration repository.</li>
<li>Permissions in Microsoft Entra to create app registrations and assign roles in the new tenant.</li>
<li>PowerShell 5.1 or later &amp; VS Code installed on your local machine.</li>
<li>Clone the <code>Staff-Infrastructure-Microsoft365-DSC-Configuration</code> Repository to your device within VS Code</li>
<li>Create a feature branch in the Configuration repository using the naming convention: feature/<Identifier> Example: feature/TenantXYZ-onboarding</li>
</ol>

<blockquote>
<p>NOTE: Remember to check the Global and Enforced configurations that are already set prior to onboarding a new environment, if any of these settings are not appropriate for the new target tenant then these workload settings should be moved back to the tenant specific data files prior to onboarding the new tenant.</p>
</blockquote>
<h3 id="2-create-app-registration">2. Create App Registration</h3>
<h4 id="2-1-create-a-certificate">2.1 Create a certificate</h4>
<p>Generate a new authentication certificate that will be used by the app registration using the following script:</p>
<div class="highlight"><pre class="highlight powershell" tabindex="0"><code><span class="w">
</span><span class="nv">$clientCert</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">New-SelfSignedCertificate</span><span class="w"> </span><span class="nt">-Subject</span><span class="w"> </span><span class="s2">"CN=Microsoft365DSC"</span><span class="w"> </span><span class="nt">-CertStoreLocation</span><span class="w"> </span><span class="s2">"Cert:\LocalMachine\My"</span><span class="w"> </span><span class="nt">-KeyExportPolicy</span><span class="w"> </span><span class="nx">Exportable</span><span class="w"> </span><span class="nt">-KeySpec</span><span class="w"> </span><span class="nx">Signature</span><span class="w">

</span><span class="nv">$password</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ConvertTo-SecureString</span><span class="w"> </span><span class="nt">-String</span><span class="w"> </span><span class="s2">"&lt;password&gt;"</span><span class="w"> </span><span class="nt">-AsPlainText</span><span class="w"> </span><span class="nt">-Force</span><span class="w">

</span><span class="n">Export-PfxCertificate</span><span class="w"> </span><span class="nt">-Cert</span><span class="w"> </span><span class="nv">$clientCert</span><span class="w"> </span><span class="nt">-FilePath</span><span class="w"> </span><span class="nx">C:\</span><span class="err">&lt;</span><span class="nx">TenantShortName</span><span class="err">&gt;</span><span class="nx">M365ClientCert.pfx</span><span class="w"> </span><span class="nt">-Password</span><span class="w"> </span><span class="nv">$password</span><span class="w">

</span><span class="n">Export-Certificate</span><span class="w"> </span><span class="nt">-Cert</span><span class="w"> </span><span class="nv">$clientCert</span><span class="w"> </span><span class="nt">-FilePath</span><span class="w"> </span><span class="nx">C:\</span><span class="err">&lt;</span><span class="nx">TenantShortName</span><span class="err">&gt;</span><span class="nx">M365ClientCert.cer</span><span class="w">

</span><span class="nv">$clientCert</span><span class="o">.</span><span class="nf">Thumbprint</span><span class="w">

</span></code></pre></div><p><strong>Take note of the Certificate Thumbprint and PFX Password for later use.</strong></p>

<blockquote>
<p>NOTE: Update the Password and TenantShortName to relevant values</p>
</blockquote>
<h4 id="2-2-create-an-app-registration-and-configure-permissions">2.2 Create an App Registration and Configure Permissions</h4>

<ol>
<li>Download <a href="https://github.com/ykuijs/M365DSC_CICD/blob/main/Supportscripts/CreateServicePrincipals.psm1">this</a> script to your machine</li>
<li>Load the downloaded module into your PowerShell session to support programmatic creation of the service principal:</li>
</ol>
<div class="highlight"><pre class="highlight powershell" tabindex="0"><code><span class="w">    </span><span class="n">Import-Module</span><span class="w"> </span><span class="err">&lt;</span><span class="nx">Script_Path</span><span class="err">&gt;</span><span class="nx">\CreateServicePrincipals.psm1</span><span class="w">    
</span></code></pre></div>
<ol>
<li>Create the app registration and grant the correct permissions by running the following PowerShell commands:</li>
</ol>
<div class="highlight"><pre class="highlight powershell" tabindex="0"><code><span class="w">    </span><span class="nv">$DSCAppName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"MoJO-&lt;TenantShortName&gt;-M365DSC-ConfigurationDeployment"</span><span class="w">
    </span><span class="nv">$tempPath</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"</span><span class="si">$(</span><span class="nv">$</span><span class="nn">env</span><span class="p">:</span><span class="nv">USERPROFILE</span><span class="si">)</span><span class="s2">\Downloads"</span><span class="w">
    </span><span class="n">New-M365DSCServicePrincipal</span><span class="w"> </span><span class="nt">-Credential</span><span class="w"> </span><span class="p">(</span><span class="n">Get-Credential</span><span class="p">)</span><span class="w"> </span><span class="nt">-ServicePrincipalName</span><span class="w"> 
    </span><span class="nv">$DSCAppName</span><span class="w"> </span><span class="nt">-CertificatePath</span><span class="w"> </span><span class="err">&lt;</span><span class="n">TenantShortName</span><span class="err">&gt;</span><span class="nx">M365ClientCert.cer</span><span class="w">
</span></code></pre></div>
<ol>
<li>At the end of the script, the output shows details of the created app, take note of these details. These are required in further steps.</li>
</ol>

<blockquote>
<p>NOTE: Update the TenantShortName to a relevant value</p>
<p>NOTE: The script allows for creation of service principals for a specific workload. If you use the Workload parameter, the script will only grant the required permissions for that workload.</p>
<p>NOTE: To see which permissions are required for which resource, use the <a href="https://microsoft365dsc.com/user-guide/cmdlets/Get-M365DSCCompiledPermissionList/">Get-M365CompiledPermissionList</a> cmdlet or review the documentation of each resource in the Resources section on <a href="https://microsoft365dsc.com">Microsoft365DSC.com</a></p>
</blockquote>
<h4 id="2-3-grant-admin-consent">2.3 Grant Admin Consent</h4>

<ol>
<li>Grant Admin Consent for the assigned API permissions in Entra ID.</li>
</ol>
<h3 id="3-provision-data-files">3. Provision Data Files</h3>
<h4 id="3-1-run-the-provisioning-script">3.1 Run the provisioning script</h4>

<ol>
<li>Navigate to the Staff-Infrastructure-Microsoft365-DSC-Configuration\DataFiles\Templates directory.</li>
<li>Execute the ProvisionNewEnvironment.ps1 script to generate the required data files for the new tenant:</li>
</ol>
<div class="highlight"><pre class="highlight powershell" tabindex="0"><code><span class="w">    </span><span class="o">.</span><span class="n">\ProvisionNewEnvironment.ps1</span><span class="w"> </span><span class="nt">-EnvironmentName</span><span class="w"> </span><span class="s2">"Tenant_ShortName"</span><span class="w">
</span></code></pre></div>
<blockquote>
<p>NOTE: Update the Tenant_ShortName with the short name of the tenant e.g. MoJoDEV</p>
</blockquote>
<h4 id="3-2-update-the-generic-psd1-file">3.2 Update the Generic.psd1 file</h4>

<ol>
<li>Locate the newly created Generic.psd1 file in the DataFiles\Tenants directory.</li>
<li>Update the following sections in the file:
    * Used Workloads: Specify which workloads (e.g., Exchange, Teams, SharePoint) are used by the tenant.
    * Tokens Section: Leave placeholders as they are but ensure the tokens section is updated with the correct values.
    * App Credentials: Add the App ID and Certificate Thumbprint for each workload.</li>
</ol>

<blockquote>
<p>NOTE: Reference the existing tenants Generic.psd1 files if needed as an example</p>
</blockquote>
<h4 id="3-4-add-the-certificate">3.4 Add the Certificate</h4>

<ol>
<li>Place the .pfx certificate file in the same directory as the Generic.psd1 file.</li>
<li>Ensure the certificate file follows the naming convention: <code>Tenant_ShortNameM365ClientCert.pfx</code></li>
</ol>
<h3 id="4-commit-changes">4. Commit Changes</h3>

<ol>
<li>Open Visual Studio Code and navigate to the Staff-Infrastructure-Microsoft365-DSC-Configuration repository.</li>
<li>Stage the changes:
    * Add the updated Generic.psd1 file and the .pfx certificate file.</li>
<li>Commit the changes to the feature branch, Use a meaningful commit message, such as &ldquo;Onboarded new tenant: Tenant_ShortName&rdquo;</li>
<li>Sync the changes to the remote feature branch</li>
</ol>
<h3 id="5-run-the-dependencies-pipeline">5. Run the Dependencies Pipeline</h3>

<ol>
<li>Navigate to the Azure DevOps portal and locate the dependencies.yaml pipeline in the Staff-Infrastructure-Microsoft365-DSC-Configuration repository.</li>
<li>Add the following Environments parameter array to the pipeline:
    <code>Environments:
     - Name: &quot;Tenant_ShortName&quot;
       CertificatePassword: &quot;$(Tenant_ShortNameCertPassword)&quot;</code>
       * Replace Tenant_ShortName with the tenants short name.
       * Add the certificate password as a secret pipeline variable in Azure DevOps.</li>
<li>Trigger the pipeline and monitor its execution to ensure all dependencies are successfully configured.</li>
</ol>
<h3 id="6-validation">6. Validation</h3>
<h4 id="6-1-build-validation">6.1 Build Validation</h4>

<ol>
<li>Manually run the build.yaml pipeline in the feature branch to ensure it completes successfully.</li>
</ol>
<h4 id="6-2-pull-request-process">6.2 Pull Request Process</h4>

<ol>
<li>Create a pull request (PR) from the feature branch to the develop branch.</li>
<li>Once the PR is approved and merged, create another PR from develop to main.</li>
<li>The PR into main will trigger the PR validation pipeline.</li>
</ol>
<h4 id="6-3-cicd-triggers">6.3 CICD Triggers</h4>

<ol>
<li>Once the changes are merged into main, the following pipelines will be triggered automatically

<ul>
<li>build.yaml</li>
<li>deployment.yaml</li>
<li>testcompliancy.yaml</li>
</ul></li>
</ol>
<h2 id="compliancy-checks">Compliancy Checks</h2>
<p>This solution runs the Check Compliancy pipeline twice daily, once at 08:00 and once at 18:00 daily. When this pipeline runs it checks the configuration of each tenant that are under management of Microsoft 365 DSC against the data files that are specified in the configuration repositories to make sure all workload settings that are defined within DSC are compliant. At current maturity this solution does not enforce automatic remediation actions if DSC notices a configuration drift within the tenant, the results of these checks are sent to XXXXXXXXX for administrators to observe.</p>
<p>By continuously monitoring the environment, MoJ ensure that the tenants are in their intended state before the start of, and at the end of, the organisations core working hours reducing the risk of misconfigurations that may impact the end user experience or security posture.</p>

            
          </main>

          <aside>
              <ul class="contribution-banner">
                <li><a href="https://github.com/ministryofjustice/Staff-Infrastructure-Microsoft365-DSC-Documentation/blob/main/source/documentation/new-tenant.html.md.erb">View source</a></li>
                <li><a href="https://github.com/ministryofjustice/Staff-Infrastructure-Microsoft365-DSC-Documentation/issues/new?body=Problem+with+%27%27+%28https%3A%2F%2Fministryofjustice.github.io%2FStaff-Infrastructure-Microsoft365-DSC-Documentation%2Fdocumentation%2Fnew-tenant.html%29&amp;labels=bug&amp;title=Re%3A+%27%27">Report problem</a></li>
                <li><a href="https://github.com/ministryofjustice/Staff-Infrastructure-Microsoft365-DSC-Documentation">GitHub Repo</a></li>
              </ul>
          </aside>

          <footer class="govuk-footer app-footer" role="contentinfo">
  <div class="govuk-footer__meta">
    <div class="govuk-footer__meta-item govuk-footer__meta-item--grow">


      <svg
        aria-hidden="true"
        focusable="false"
        class="govuk-footer__licence-logo"
        xmlns="http://www.w3.org/2000/svg"
        viewbox="0 0 483.2 195.7"
        height="17"
        width="41"
      >
        <path
          fill="currentColor"
          d="M421.5 142.8V.1l-50.7 32.3v161.1h112.4v-50.7zm-122.3-9.6A47.12 47.12 0 0 1 221 97.8c0-26 21.1-47.1 47.1-47.1 16.7 0 31.4 8.7 39.7 21.8l42.7-27.2A97.63 97.63 0 0 0 268.1 0c-36.5 0-68.3 20.1-85.1 49.7A98 98 0 0 0 97.8 0C43.9 0 0 43.9 0 97.8s43.9 97.8 97.8 97.8c36.5 0 68.3-20.1 85.1-49.7a97.76 97.76 0 0 0 149.6 25.4l19.4 22.2h3v-87.8h-80l24.3 27.5zM97.8 145c-26 0-47.1-21.1-47.1-47.1s21.1-47.1 47.1-47.1 47.2 21 47.2 47S123.8 145 97.8 145"
        />
      </svg>
      <span class="govuk-footer__licence-description">
        All content is available under the
        <a
          class="govuk-footer__link"
          href="https://www.nationalarchives.gov.uk/doc/open-government-licence/version/3/"
          rel="license"
        >Open Government Licence v3.0</a>, except where otherwise stated
      </span>
    </div>
    <div class="govuk-footer__meta-item">
      <a
        class="govuk-footer__link govuk-footer__copyright-logo"
        href="https://www.nationalarchives.gov.uk/information-management/re-using-public-sector-information/uk-government-licensing-framework/crown-copyright/"
      >© Crown copyright</a>
    </div>
  </div>
</footer>

        </div>
      </div>
    </div>

    
    <script src="../javascripts/application.js"></script>
  </body>
</html>
